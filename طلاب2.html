<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š Ø§Ø¯Ø§Ø±Ø© Ø·Ù„Ø§Ø¨ ÙˆØ·Ø§Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ğŸ’¾</title>
    <!-- Ø®Ø·ÙˆØ· Ø¹Ø±Ø¨ÙŠØ© Ù…Ø­Ø³Ù†Ø©: ÙƒØ§ÙŠØ±Ùˆ Ù„Ù„ÙˆØ¶ÙˆØ­ ÙˆØ§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ====================================================================== */
        /* Ø§Ù„Ù‚Ø³Ù… 1: Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø«ÙŠÙ…Ø§Øª (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ø¯Ø§ÙƒÙ†Ø©) */
        /* ====================================================================== */
        :root {
            /* Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„ÙØ§ØªØ­ (ÙƒØ®ÙŠØ§Ø± Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆÙ„Ø¶Ø¨Ø· Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø«ÙŠÙ… Ø§Ù„ÙØ§ØªØ­) */
            --primary-color: #3498db; 
            --secondary-color: #2ecc71;
            --accent-color: #f1c40f; 
            --error-color: #e74c3c; 
            --bg-color: #ecf0f1; 
            --text-color: #2c3e50; 
            --container-bg: #ffffff; 
            --input-bg: #f9f9f9;
            --border-color: #bdc3c7;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --button-hover-bg: #2980b9;
        }

        /* --- 1. Ø«ÙŠÙ… Ø§Ù„Ù„ÙŠØ§Ù„ÙŠ Ø§Ù„Ø¯Ø§ÙƒÙ†Ø© (Default Dark) --- */
        .theme-DarkNights {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --accent-color: #f1c40f;
            --error-color: #e74c3c;
            --bg-color: #121212; /* Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ Ø¹Ù…ÙŠÙ‚Ø© */
            --text-color: #ecf0f1; /* Ù†Øµ ÙØ§ØªØ­ */
            --container-bg: #1f1f1f; /* Ø­Ø§ÙˆÙŠØ© Ø±Ù…Ø§Ø¯ÙŠØ© Ø¯Ø§ÙƒÙ†Ø© */
            --input-bg: #2c3e50;
            --border-color: #3e4f61;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            --button-hover-bg: #2980b9;
        }

        /* --- 2. Ø«ÙŠÙ… Ø§Ù„Ø²Ù…Ø±Ø¯ Ø§Ù„Ø¯Ø§ÙƒÙ† --- */
        .theme-EmeraldDark {
            --primary-color: #2ecc71; /* Ø§Ù„Ø²Ù…Ø±Ø¯ÙŠ */
            --secondary-color: #3498db;
            --accent-color: #f39c12;
            --bg-color: #181A1B; 
            --text-color: #ecf0f1; 
            --container-bg: #232729; 
            --input-bg: #2C3A3F;
            --border-color: #3e5f4a;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            --button-hover-bg: #27ae60;
        }
        
        /* --- 3. Ø«ÙŠÙ… Ø§Ù„Ù…Ø·Ø± Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠ --- */
        .theme-PurpleRain {
            --primary-color: #9b59b6; /* Ø¨Ù†ÙØ³Ø¬ÙŠ */
            --secondary-color: #3498db;
            --accent-color: #f1c40f;
            --bg-color: #212130; 
            --text-color: #ecf0f1; 
            --container-bg: #2C2C40; 
            --input-bg: #3A3A55;
            --border-color: #554477;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            --button-hover-bg: #8e44ad;
        }
        
        /* --- 4. Ø«ÙŠÙ… Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†ÙŠ --- */
        .theme-CarbonGrey {
            --primary-color: #f39c12; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± */
            --secondary-color: #2ecc71;
            --accent-color: #3498db;
            --bg-color: #222222; 
            --text-color: #ffffff; 
            --container-bg: #333333; 
            --input-bg: #444444;
            --border-color: #555555;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            --button-hover-bg: #e67e22;
        }
        
        /* --- 5. Ø«ÙŠÙ… Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ù…ÙŠ --- */
        .theme-BloodOrange {
            --primary-color: #e67e22; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù…Ø­Ù…Ø± */
            --secondary-color: #2ecc71;
            --accent-color: #3498db;
            --bg-color: #0d0d0d; 
            --text-color: #ffffff; 
            --container-bg: #1a1a1a; 
            --input-bg: #2a2a2a;
            --border-color: #4a4a4a;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            --button-hover-bg: #d35400;
        }
        
        /* ====================================================================== */
        /* Ø§Ù„Ù‚Ø³Ù… 2: Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ù‡ÙŠÙƒÙ„ÙŠØ© */
        /* ====================================================================== */
        * {
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s, border-color 0.3s;
        }

        body {
            font-family: 'Amiri', serif;  /* ØªÙØ¶ÙŠÙ„ ÙƒØ§ÙŠØ±Ùˆ Ù„Ù„ÙˆØ¶ÙˆØ­ */
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            direction: rtl;
            text-align: right;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px; 
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            flex-grow: 1;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
            font-size: 2.2rem;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            font-weight: 900;
        }
        
        h2 {
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.6rem;
            font-weight: 700;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ù…Ø­Ø¯Ø¯Ø§Øª */
        input[type="text"], 
        input[type="number"], 
        input[type="date"],
        select {
            width: 100%;
            padding: 12px;
            margin: 10px 0 20px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 5px var(--primary-color);
            background-color: var(--input-bg);
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        button {
            background-color: var(--primary-color);
            color: #ffffff;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin: 5px;
            text-align: center;
            white-space: nowrap;
            transition: all 0.2s ease-in-out;
        }

        button:hover {
            background-color: var(--button-hover-bg);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }
        
        /* ====================================================================== */
        /* Ø§Ù„Ù‚Ø³Ù… 3: Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Tabs) ÙˆØ§Ù„ØªØ­ÙƒÙ… */
        /* ====================================================================== */
        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 10px;
            background-color: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .controls-bar > div {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        #theme-selector {
            padding: 8px;
            border-radius: 6px;
            background-color: var(--container-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            font-weight: 700;
        }

        .tab-buttons {
            display: flex;
            justify-content: flex-start;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            flex-wrap: wrap;
            width: 100%;
        }

        .tab-button {
            background-color: transparent;
            color: var(--text-color);
            border-radius: 0;
            border-bottom: none;
            padding: 10px 20px;
            margin: 0 5px -2px 0;
            box-shadow: none;
            font-size: 1rem;
            opacity: 0.7;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            transition: background-color 0.2s, opacity 0.2s, color 0.2s;
        }

        .tab-button.active {
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
            opacity: 1;
            font-weight: 700;
        }
        
        .tab-content {
            display: none;
            padding-top: 15px;
        }

        .tab-content.active {
            display: block;
        }
        
        /* ====================================================================== */
        /* Ø§Ù„Ù‚Ø³Ù… 4: Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Dashboard) */
        /* ====================================================================== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background-color: var(--input-bg);
            padding: 25px;
            border-radius: 12px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.2);
            text-align: center;
        }

        .dashboard-card h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .dashboard-card p.value {
            font-size: 2.8rem;
            font-weight: 900;
            color: var(--secondary-color); /* Ù„ÙˆÙ† Ø§Ù„Ø¥Ø¨Ø±Ø§Ø² Ù„Ù„Ù…Ø¨Ø§Ù„Øº */
            margin: 10px 0 0 0;
        }
        
        /* ====================================================================== */
        /* Ø§Ù„Ù‚Ø³Ù… 5: Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ */
        /* ====================================================================== */
        .search-container {
            margin-bottom: 25px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-container input[type="text"] {
            margin: 0;
            flex-grow: 1;
        }

        /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .amount-cell {
            font-weight: 900;
            color: var(--secondary-color);
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠÙ† */
        .date-cell {
            font-size: 0.9rem;
        }
        
        .date-cell .hijri {
            display: block;
            font-size: 0.8rem;
            color: var(--accent-color);
            font-weight: 700;
            margin-top: 2px;
        }

        /* Ø¥Ø®ÙØ§Ø¡ input file Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ */
        #import-file-input {
            display: none;
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow);
            background-color: var(--container-bg);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px; /* Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        }

        .data-table th, .data-table td {
            padding: 14px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
            word-break: break-word;
        }

        .data-table th {
            background-color: var(--primary-color);
            color: #ffffff;
            cursor: pointer;
            position: sticky;
            top: 0;
            font-weight: 700;
        }

        .data-table tr:nth-child(even) {
            background-color: var(--input-bg); 
        }

        .data-table tr:hover {
            background-color: rgba(52, 152, 219, 0.1); /* ØªØ£Ø«ÙŠØ± Ø®ÙÙŠÙ Ù„Ù„ØªØ­ÙˆÙŠÙ… */
        }
        
        .action-buttons-cell button {
            padding: 8px 12px;
            font-size: 0.9rem;
            margin: 2px;
        }
        
        /* ====================================================================== */
        /* Ø§Ù„Ù‚Ø³Ù… 6: Ø§Ù„Ø¥Ù‡Ø¯Ø§Ø¡ ÙÙŠ Ø§Ù„ÙÙˆØªØ± */
        /* ====================================================================== */
        #footer-gift {
            color: var(--primary-color);
            text-align: center;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            text-shadow: 0 0 5px rgba(52, 152, 219, 0.7);
            border-top: 2px dashed var(--border-color);
            width: 100%;
            max-width: 1200px;
            margin-top: 20px;
            background-color: var(--container-bg);
            border-radius: 12px;
        }
        
        /* ====================================================================== */
        /* Ø§Ù„Ù‚Ø³Ù… 7: Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© (Responsive) */
        /* ====================================================================== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8rem;
            }
            
            .controls-bar {
                flex-direction: column;
                gap: 15px;
                padding: 10px;
            }
            
            .tab-buttons {
                flex-direction: column;
            }

            .tab-button {
                flex-grow: 1;
                margin: 5px 0;
                border-radius: 8px;
            }
            
            .tab-button.active {
                border-bottom: none;
            }
            
            .dashboard-card p.value {
                font-size: 2rem;
            }
            
            .data-table th, .data-table td {
                padding: 8px;
                font-size: 0.85rem;
            }

            .date-cell .hijri {
                font-size: 0.7rem;
            }
            
            .action-buttons-cell button {
                display: block;
                width: 100%;
                margin: 5px 0;
            }
            
            .search-container {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body class="theme-DarkNights">

<!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø®ØµØµ -->
<div id="custom-alert" style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); padding: 10px 20px; background-color: var(--primary-color); color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); z-index: 1000; display: none; font-weight: 700;"></div>

<div class="container">
    
    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø«ÙŠÙ… ÙˆØ§Ù„ØªØ«Ø¨ÙŠØª -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);">
        <h2 style="font-size: 1.2rem; color: var(--primary-color); margin: 0;">Ù…Ø±ÙˆØ§Ù† Ù‡Ø§Ù†ÙŠ Ø§Ù„Ù†Ø¬Ø§Ø± - Ù…Ø·ÙˆØ± Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
        <!-- Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª ÙÙŠ Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ ÙˆØ§Ø¶Ø­ -->
        <p id="datetime-display" style="font-weight: 700; color: var(--text-color); margin: 0; text-align: left; font-size: 0.9rem;"></p>
    </div>

    <h1>ğŸ“ŠØ§Ø¯Ø§Ø±Ø© Ø·Ù„Ø§Ø¨ ÙˆØ·Ø§Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ğŸ’¾</h1>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø«ÙŠÙ… ÙˆØ§Ù„ØªØ«Ø¨ÙŠØª -->
    <div class="controls-bar">
        <div>
            <label for="theme-selector" style="font-weight: 700;">ğŸ¨ Ø§Ø®ØªØ± Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ø¯Ø§ÙƒÙ†:</label>
            <select id="theme-selector" onchange="changeTheme(this.value)">
                <option value="DarkNights">1. Ø§Ù„Ù„ÙŠØ§Ù„ÙŠ Ø§Ù„Ø¯Ø§ÙƒÙ†Ø© (Default)</option>
                <option value="EmeraldDark">2. Ø§Ù„Ø²Ù…Ø±Ø¯ Ø§Ù„Ø¯Ø§ÙƒÙ†</option>
                <option value="PurpleRain">3. Ø§Ù„Ù…Ø·Ø± Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠ</option>
                <option value="CarbonGrey">4. Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†ÙŠ</option>
                <option value="BloodOrange">5. Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø§Ù…ÙŠ</option>
                <option value="Light">6. Ø§Ù„Ø«ÙŠÙ… Ø§Ù„ÙØ§ØªØ­</option>
            </select>
        </div>
        
        <button id="install-button" style="background-color: var(--secondary-color); display: none;" onclick="promptInstall()">
            â¬‡ï¸ ØªØ«Ø¨ÙŠØª/ØªØ´ØºÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² (PWA)
        </button>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <div class="tab-buttons">
        <button class="tab-button active" onclick="openTab('dashboardTab')">ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        <button class="tab-button" onclick="openTab('dataEntryTab')">â• Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨</button>
        <button class="tab-button" onclick="openTab('dataViewTab')">ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ</button>
    </div>

    <!-- ====================================================================== -->
    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ 1: Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Dashboard) - Ø´Ø§Ø´Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <!-- ====================================================================== -->
    <div id="dashboardTab" class="tab-content active">
        <h2>Ø´Ø§Ø´Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
        <div class="dashboard-grid">
            <div class="dashboard-card" style="border-color: var(--primary-color);">
                <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</h3>
                <p class="value" id="stat-total-students" style="color: var(--primary-color);">0</p>
            </div>
            <div class="dashboard-card" style="border-color: var(--secondary-color);">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ‘Ù„ (Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ)</h3>
                <p class="value" id="stat-total-paid" style="color: var(--secondary-color);">0</p>
            </div>
            <div class="dashboard-card" style="border-color: var(--accent-color);">
                <h3>ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø¯ÙØ¹Ø© ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ø§</h3>
                <p class="value" style="font-size: 1.5rem; color: var(--accent-color);" id="stat-last-payment-date">---</p>
            </div>
        </div>
        <div style="padding: 15px; background-color: var(--input-bg); border-radius: 8px; border: 1px solid var(--border-color);">
            <p style="margin: 0; font-weight: 700; color: var(--text-color);">
Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ù‚Ø¯Ù… Ù…Ù† Ù…Ø±ÙˆØ§Ù† Ù‡Ø§Ù†ÙŠ Ø§Ù„Ù†Ø¬Ø§Ø± Ù„ØªØ­ÙÙŠØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…               </p>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ 2: Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨ (Data Entry) -->
    <!-- ====================================================================== -->
    <div id="dataEntryTab" class="tab-content">
        <h2 id="form-title">Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
        <form id="student-form">
            <input type="hidden" id="student-id" value="">
            
            <label for="student-name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨: *</label>
            <input type="text" id="student-name" required placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±ÙˆØ§Ù† Ù‡Ø§Ù†ÙŠ Ø§Ù„Ù†Ø¬Ø§Ø±">
            
            <!-- Ø­Ù‚Ù„ Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯ (Select) -->
            <label for="student-level">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ/Ø§Ù„ØµÙ: *</label>
            <select id="student-level" required>
                <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ --</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø§ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                <option value="Ù…Ø±Ø­Ù„Ù‡ Ø¬Ø§Ù…Ø¹ÙŠÙ‡">Ù…Ø±Ø­Ù„Ù‡ Ø¬Ø§Ù…Ø¹ÙŠÙ‡</option>
                <option value="Ø®Ø±ÙŠØ¬/Ù‡">Ø®Ø±ÙŠØ¬/Ù‡</option>
            </select>
            
            <label for="student-phone">Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø·Ø§Ù„Ø¨/ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <input type="text" id="student-phone" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">

            <label for="birth-date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <input type="date" id="birth-date">
            
            <label for="paid-amount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹: (Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ù…ØµØ±ÙŠ) *</label>
            <input type="number" id="paid-amount" required min="" value="" placeholder="Ù…Ø«Ø§Ù„: 80">
            
            <!-- Ø­Ù‚Ù„ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ (Select) - Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙƒÙ…Ø§ Ø·ÙÙ„Ø¨ -->
            <label for="payment-method">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ (Payment Method): *</label>
            <select id="payment-method" required>
                <option value="" disabled selected>-- Select Payment Method --</option>
                <option value="Cash">1. Cash</option>
                <option value="Instapay">2. Instapay</option>
                <option value="Vodafone Cash">3. Vodafone Cash</option>
                <option value="e& Cash">4. e& Cash</option>
                <option value="Orange Cash">5. Orange Cash</option>
                <option value="We Pay">6. We Pay</option>
            </select>

            <label for="last-payment-date">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø¯ÙØ¹: (ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…) *</label>
            <input type="date" id="last-payment-date" required>
            
            <div class="action-buttons" style="margin-top: 20px;">
                <button type="submit" id="save-button">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <button type="button" onclick="resetForm(true)" id="clear-button" style="background-color: var(--error-color);">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
            </div>
        </form>
    </div>

    <!-- ====================================================================== -->
    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ 3: Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ (Data View) -->
    <!-- ====================================================================== -->
    <div id="dataViewTab" class="tab-content">
        <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† (Ù„Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„)</h2>
        
        <div class="search-container">
            <label for="search-input" style="font-weight: 700; color: var(--text-color);">ğŸ” Ø§Ø¨Ø­Ø« ÙÙˆØ±ÙŠØ§Ù‹ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</label>
            <input type="text" id="search-input" oninput="renderTable()" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ..." style="max-width: 400px;">
            <button onclick="exportData('csv')" style="background-color: var(--secondary-color);">ğŸ“¤ ØªØµØ¯ÙŠØ± CSV</button>
            <button onclick="exportData('json')" style="background-color: var(--accent-color);">ğŸ“¤ ØªØµØ¯ÙŠØ± JSON</button>
            <!-- Ø²Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
            <button onclick="document.getElementById('import-file-input').click()" style="background-color: #9b59b6;">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
            <input type="file" id="import-file-input" accept=".json" onchange="importData(event)">
        </div>
        
        <div class="table-container">
            <table class="data-table" id="student-table">
                <thead>
                    <tr>
                        <th data-sort-key="name" onclick="sortTable('name')">Ø§Ù„Ø§Ø³Ù…</th>
                        <th data-sort-key="level" onclick="sortTable('level')">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
                        <!-- ØªÙ… Ø¯Ù…Ø¬ Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠÙ† Ù‡Ù†Ø§ -->
                        <th data-sort-key="birthDate" onclick="sortTable('birthDate')">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ù…ÙŠÙ„Ø§Ø¯ÙŠ/Ù‡Ø¬Ø±ÙŠ)</th>
                        <th data-sort-key="paidAmount" onclick="sortTable('paidAmount')">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø¬Ù†ÙŠÙ‡)</th>
                        <th data-sort-key="paymentMethod" onclick="sortTable('paymentMethod')">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                        <th data-sort-key="lastPaymentDate" onclick="sortTable('lastPaymentDate')">Ø¢Ø®Ø± Ø¯ÙØ¹ (Ù…ÙŠÙ„Ø§Ø¯ÙŠ/Ù‡Ø¬Ø±ÙŠ)</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="student-table-body">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„ØµÙÙˆÙ Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                </tbody>
            </table>
        </div>
        <p id="no-data-message" style="text-align: center; color: var(--primary-color); margin-top: 30px; display: none; font-weight: 700;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ·Ø§Ø¨Ù‚ Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø«.</p>
    </div>

</div> <!-- Ù†Ù‡Ø§ÙŠØ© .container -->

<!-- Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ù…Ø¶ÙŠØ¡ (Ø§Ù„Ø¥Ù‡Ø¯Ø§Ø¡) -->
<div id="footer-gift">
    Ù‡Ø¯ÙŠØ© Ù…Ù† Ù…Ø±ÙˆØ§Ù† Ù‡Ø§Ù†ÙŠ Ø§Ù„Ù†Ø¬Ø§Ø± Ø¥Ù„Ù‰ ØªØ­ÙÙŠØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… - Prog Marwan H EL-Nagar
</div>

<script>
    // ======================================================================
    // Ø§Ù„Ù‚Ø³Ù… 1: Ø§Ù„Ø«ÙˆØ§Ø¨Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    // ======================================================================
    const STORAGE_KEY = 'studentPaymentsDataV4_Marwan_Final'; // Ù…ÙØªØ§Ø­ ØªØ®Ø²ÙŠÙ† Ø¬Ø¯ÙŠØ¯ ÙˆÙ…Ù†Ø¸Ù…
    const THEME_KEY = 'marwan_payment_theme'; // Ù…ÙØªØ§Ø­ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø«ÙŠÙ…
    const CURRENCY_CODE = 'EGP'; // ** Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ **
    
    let students = [];
    let sortConfig = { key: 'name', direction: 'asc' };
    let deferredPrompt = null; // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø­Ø¯Ø« PWA

    /**
     * ÙŠØ­ÙˆÙ„ ÙƒØ§Ø¦Ù† Date Ø¥Ù„Ù‰ Ø³Ù„Ø³Ù„Ø© Ù†ØµÙŠØ© Ø¨ØªÙ†Ø³ÙŠÙ‚ YYYY-MM-DD
     */
    function dateToInputString(date) {
        if (!date || isNaN(date)) return '';
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // ======================================================================
    // Ø§Ù„Ù‚Ø³Ù… 2: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ© (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Alert/Confirm)
    // ======================================================================
    function showAlert(message, type = 'info') {
        const alertBox = document.getElementById('custom-alert');
        if (!alertBox) return;

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        let bgColor = getComputedStyle(document.body).getPropertyValue('--primary-color'); 
        if (type === 'success') bgColor = getComputedStyle(document.body).getPropertyValue('--secondary-color');
        if (type === 'error') bgColor = getComputedStyle(document.body).getPropertyValue('--error-color');
        if (type === 'warning') bgColor = getComputedStyle(document.body).getPropertyValue('--accent-color');


        alertBox.textContent = message;
        alertBox.style.backgroundColor = bgColor;
        alertBox.style.color = getComputedStyle(document.body).getPropertyValue('--text-color') === '#ffffff' ? '#000000' : '#ffffff';
        alertBox.style.display = 'block';

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 4 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(() => {
            alertBox.style.display = 'none';
        }, 4000);
    }
    
    // ======================================================================
    // Ø§Ù„Ù‚Ø³Ù… 3: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® (Ù…ÙŠÙ„Ø§Ø¯ÙŠ ÙˆÙ‡Ø¬Ø±ÙŠ) - Ù…ÙØ­Ø³Ù‘Ù†
    // ======================================================================

    /**
     * ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ® Ù…ÙŠÙ„Ø§Ø¯ÙŠ Ø¥Ù„Ù‰ Ø¹Ø±Ø¶ Ù…ÙŠÙ„Ø§Ø¯ÙŠ/Ù‡Ø¬Ø±ÙŠ
     * @param {Date | null} dateObj ÙƒØ§Ø¦Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¹Ø±Ø¶Ù‡
     * @returns {string} Ø³Ù„Ø³Ù„Ø© HTML ØªØ¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠÙ†.
     */
    function formatDateTimeDisplay(dateObj) {
        if (!dateObj || isNaN(dateObj.getTime())) {
            return '---';
        }

        const lang = 'ar-EG';

        // Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ Ø§Ù„Ù…Ø®ØªØµØ± (YYYY/MM/DD)
        const gregorianOptions = { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit', 
        };
        const gregorianDate = dateObj.toLocaleDateString(lang, gregorianOptions).replace(/\//g, '-');

        // Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‡Ø¬Ø±ÙŠ Ø§Ù„Ù…Ø®ØªØµØ± (YYYY/MM/DD) - Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰
        const hijriOptions = { 
            calendar: 'islamic-umalqura', 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit'
        };
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… 'ar-SA' Ù„Ø¶Ù…Ø§Ù† ØªÙ†Ø³ÙŠÙ‚ Ù‡Ø¬Ø±ÙŠ ØµØ­ÙŠØ­
        const hijriDate = dateObj.toLocaleDateString('ar-SA', hijriOptions).replace('Ù‡Ù€', '').trim().replace(/\//g, '-');
        
        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠÙ† ÙÙŠ Ø³Ø·Ø±ÙŠÙ† Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø±Ø¤ÙŠØ© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        return `<span class="gregorian">${gregorianDate}</span><span class="hijri">(${hijriDate} Ù‡Ù€)</span>`;
    }
    
    /**
     * ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø¨Ø´ÙƒÙ„ Ù…ÙØµÙ‘Ù„)
     */
    function updateHeaderDateTime() {
        const now = new Date();
        const lang = 'ar-EG';

        // Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
        const gregorianOptions = { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit',
            hour12: true
        };
        const gregorianDate = now.toLocaleDateString(lang, gregorianOptions);

        // Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‡Ø¬Ø±ÙŠ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰)
        const hijriOptions = { 
            calendar: 'islamic-umalqura', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric'
        };
        const hijriDate = now.toLocaleDateString('ar-SA', hijriOptions);
        
        const display = document.getElementById('datetime-display');
        display.innerHTML = `**Ù…ÙŠÙ„Ø§Ø¯ÙŠ:** ${gregorianDate} <br> **Ù‡Ø¬Ø±ÙŠ:** ${hijriDate}`;
        
        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
        setTimeout(updateHeaderDateTime, 1000);
    }
    
    // ======================================================================
    // Ø§Ù„Ù‚Ø³Ù… 4: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø«ÙŠÙ…Ø§Øª (Dark Themes)
    // ======================================================================
    
    /**
     * ØªØºÙŠÙŠØ± Ø§Ù„Ø«ÙŠÙ… ÙˆØªØ®Ø²ÙŠÙ†Ù‡ ÙÙŠ Local Storage
     */
    function changeTheme(themeName) {
        const body = document.body;
        // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ø«ÙŠÙ…Ø§Øª Ù…Ø§ Ø¹Ø¯Ø§ 'theme-DarkNights' Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ùˆ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
        body.className = body.className.split(' ').filter(c => !c.startsWith('theme-')).join(' ');

        if (themeName !== 'Light') {
            body.classList.add(`theme-${themeName}`);
        }
        
        // Ø­ÙØ¸ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        localStorage.setItem(THEME_KEY, themeName);
        
        // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        const selectedOptionText = document.getElementById('theme-selector').options[document.getElementById('theme-selector').selectedIndex].text;
        showAlert(`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø«ÙŠÙ…: ${selectedOptionText}`, 'info');
    }
    
    /**
     * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
     */
    function loadTheme() {
        const savedTheme = localStorage.getItem(THEME_KEY) || 'DarkNights'; 
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù€ body
        if (savedTheme !== 'Light') {
             document.body.classList.add(`theme-${savedTheme}`);
        }
        document.getElementById('theme-selector').value = savedTheme;
    }

    // ======================================================================
    // Ø§Ù„Ù‚Ø³Ù… 5: Ù…ÙŠØ²Ø© ØªØ«Ø¨ÙŠØª PWA (Ø²Ø± Ø§Ù„ØªÙ†Ø²ÙŠÙ„)
    // ======================================================================
    
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        // Ø¹Ø±Ø¶ Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ù…ØªØ§Ø­Ù‹Ø§
        document.getElementById('install-button').style.display = 'inline-block';
    });
    
    window.addEventListener('appinstalled', () => {
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ«Ø¨ÙŠØª
        document.getElementById('install-button').style.display = 'none';
        showAlert('âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙƒØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    });

    function promptInstall() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('PWA: User accepted the install prompt');
                } else {
                    console.log('PWA: User dismissed the install prompt');
                }
                deferredPrompt = null;
            });
        } else {
            showAlert('Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙƒÙ€ (ØªØ·Ø¨ÙŠÙ‚)ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "..." Ø£Ùˆ "Share" ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ø«Ù… Ø§Ø®ØªØ± "Add to Home Screen" Ø£Ùˆ "Install App".', 'info');
        }
    }
    
    // ======================================================================
    // Ø§Ù„Ù‚Ø³Ù… 6: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (CRUD) ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ†
    // ======================================================================
    function loadData() {
        try {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­ÙˆÙŠÙ„ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø´ÙƒÙ„ Ø³Ù„ÙŠÙ…
                students = JSON.parse(data).map(student => ({
                    ...student,
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ù†ØµÙŠØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† Date
                    lastPaymentDate: student.lastPaymentDate ? new Date(student.lastPaymentDate) : null,
                    birthDate: student.birthDate ? new Date(student.birthDate) : null,
                    paidAmount: Number(student.paidAmount) || 0,
                    paymentMethod: student.paymentMethod || 'Cash', 
                }));
            } else {
                students = [];
            }
        } catch (e) {
            console.error("Error loading data:", e);
            showAlert('âŒ Ø®Ø·Ø£: ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ. ØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø³Ø¬Ù„ ÙØ§Ø±Øº.', 'error');
            students = [];
        }
    }

    function saveData() {
        // ØªØ­ÙˆÙŠÙ„ ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ø³Ù„Ø§Ø³Ù„ YYYY-MM-DD Ù„Ù„Ø­ÙØ¸
        const dataToSave = students.map(student => ({
            ...student,
            lastPaymentDate: dateToInputString(student.lastPaymentDate),
            birthDate: dateToInputString(student.birthDate),
        }));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
    }
    
    function validateInputs(name, level, paidAmount, paymentMethod, lastPaymentDateStr) {
        if (!name || name.trim() === '') {
            showAlert('âš ï¸ Ø®Ø·Ø£: Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹.', 'error');
            return false;
        }
        if (!level || level.trim() === '') {
            showAlert('âš ï¸ Ø®Ø·Ø£: ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ.', 'error');
            return false;
        }
        if (isNaN(paidAmount) || paidAmount < 0) {
            showAlert('âš ï¸ Ø®Ø·Ø£: Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹ ÙˆÙ…ÙˆØ¬Ø¨Ø§Ù‹.', 'error');
            return false;
        }
        if (!paymentMethod || paymentMethod.trim() === '') {
            showAlert('âš ï¸ Ø®Ø·Ø£: ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹.', 'error');
            return false;
        }
        if (!lastPaymentDateStr || lastPaymentDateStr.trim() === '') {
            showAlert('âš ï¸ Ø®Ø·Ø£: ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø¯ÙØ¹.', 'error');
            return false;
        }
        return true;
    }

    document.getElementById('student-form').addEventListener('submit', function(event) {
        event.preventDefault();
        
        try {
            const id = document.getElementById('student-id').value;
            const name = document.getElementById('student-name').value.trim();
            const level = document.getElementById('student-level').value;
            const phone = document.getElementById('student-phone').value.trim();
            const paidAmount = parseFloat(document.getElementById('paid-amount').value) || 0;
            const paymentMethod = document.getElementById('payment-method').value;
            const birthDateStr = document.getElementById('birth-date').value;
            const lastPaymentDateStr = document.getElementById('last-payment-date').value;

            if (!validateInputs(name, level, paidAmount, paymentMethod, lastPaymentDateStr)) {
                return;
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø³Ù„Ø§Ø³Ù„ Ø§Ù„Ù†ØµÙŠØ©
            const birthDate = birthDateStr ? new Date(birthDateStr) : null;
            const lastPaymentDate = lastPaymentDateStr ? new Date(lastPaymentDateStr) : new Date();

            const isNew = id === '';
            
            const studentData = { id, name, level, phone, paidAmount, paymentMethod, birthDate, lastPaymentDate };

            if (isNew) {
                studentData.id = Date.now().toString(); 
                students.push(studentData);
                showAlert('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            } else {
                const index = students.findIndex(s => s.id === id);
                if (index !== -1) {
                    students[index] = { ...students[index], ...studentData };
                    showAlert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                }
            }

            saveData();
            resetForm(false); 
            calculateAndRenderDashboard();
            renderTable(); // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ù‹Ø§
            openTab('dataViewTab');
            
        } catch (e) {
            console.error("Error saving data:", e);
            showAlert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸.', 'error');
        }
    });
    
    // Ø¯Ø§Ù„Ø© Ù„Ù…Ø³Ø­ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    function resetForm(askConfirmation = true) {
        if (askConfirmation) {
            if (students.length > 0 && !confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ØŸ')) { 
                return;
            } 
        } 
        
        document.getElementById('student-id').value = '';
        document.getElementById('student-name').value = '';
        document.getElementById('student-level').value = ''; 
        document.getElementById('student-phone').value = '';
        document.getElementById('paid-amount').value = '0';
        document.getElementById('birth-date').value = '';
        document.getElementById('payment-method').value = '';

        // ØªØ¹Ø¨Ø¦Ø© ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('last-payment-date').value = dateToInputString(new Date()); 

        document.getElementById('form-title').textContent = 'Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯';
        document.getElementById('save-button').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
        
        if (askConfirmation) {
            showAlert('ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„.', 'info');
        }
    }

    function editStudent(id) {
        const student = students.find(s => s.id === id);
        if (student) {
            document.getElementById('student-id').value = student.id;
            document.getElementById('student-name').value = student.name;
            document.getElementById('student-level').value = student.level;
            document.getElementById('student-phone').value = student.phone;
            document.getElementById('paid-amount').value = student.paidAmount;
            document.getElementById('payment-method').value = student.paymentMethod;
            
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø¹Ø±Ø¶Ù‡ ÙÙŠ Ø­Ù‚Ù„ input[type=date]
            document.getElementById('birth-date').value = dateToInputString(student.birthDate);
            document.getElementById('last-payment-date').value = dateToInputString(student.lastPaymentDate);
            
            document.getElementById('form-title').textContent = `ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name}`;
            document.getElementById('save-button').textContent = 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
            
            openTab('dataEntryTab'); 
            showAlert(`ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name}`, 'info');
        }
    }

    function deleteStudent(id) {
        const student = students.find(s => s.id === id);
        if (!student) return;

        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ${student.name}ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)) {
            students = students.filter(s => s.id !== id);
            saveData();
            showAlert('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            renderTable();
            calculateAndRenderDashboard();
        }
    }

    // ======================================================================
    // Ø§Ù„Ù‚Ø³Ù… 7: Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Dashboard Logic)
    // ======================================================================
    function calculateAndRenderDashboard() {
        const totalStudents = students.length;
        // Ø§Ù„Ù…Ø¨Ù„Øº "Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯" Ù‡Ùˆ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø§ ØªÙ… ØªØ­ØµÙŠÙ„Ù‡
        const totalPaid = students.reduce((sum, s) => sum + s.paidAmount, 0);
        
        let lastPaymentDateDisplay = '---';
        if (students.length > 0) {
            // ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… ØªØ§Ø±ÙŠØ® ØµØ­ÙŠØ­ ÙˆÙØ±Ø²Ù‡Ù…
            const sortedByDate = students
                .filter(s => s.lastPaymentDate instanceof Date && !isNaN(s.lastPaymentDate))
                .sort((a, b) => b.lastPaymentDate.getTime() - a.lastPaymentDate.getTime());
                
            if (sortedByDate.length > 0) {
                // Ø¹Ø±Ø¶ Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ® Ù…ÙŠÙ„Ø§Ø¯ÙŠ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                lastPaymentDateDisplay = sortedByDate[0].lastPaymentDate.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
            }
        }

        document.getElementById('stat-total-students').textContent = totalStudents;
        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ù„Øº ÙƒØ¹Ù…Ù„Ø© (Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ EGP) Ù„ØªÙƒÙˆÙ† Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø³Ù‡Ù„Ø©
        document.getElementById('stat-total-paid').textContent = totalPaid.toLocaleString('ar-EG', { style: 'currency', currency: CURRENCY_CODE, minimumFractionDigits: 0 });
        document.getElementById('stat-last-payment-date').textContent = lastPaymentDateDisplay;
    }

    // ======================================================================
    // Ø§Ù„Ù‚Ø³Ù… 8: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„ÙØ±Ø² ÙˆØ§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ)
    // ======================================================================
    function sortTable(key) {
        let direction = 'asc';
        if (sortConfig.key === key && sortConfig.direction === 'asc') {
            direction = 'desc';
        }
        sortConfig = { key, direction };

        // Ø§Ù„ÙØ±Ø² Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ (Ø±Ù‚Ù…ØŒ ØªØ§Ø±ÙŠØ®ØŒ Ù†Øµ)
        students.sort((a, b) => {
            let valA = a[key];
            let valB = b[key];

            if (key === 'lastPaymentDate' || key === 'birthDate') {
                const dateA = valA instanceof Date && !isNaN(valA) ? valA.getTime() : 0;
                const dateB = valB instanceof Date && !isNaN(valB) ? valB.getTime() : 0;
                
                if (dateA === 0 && dateB === 0) return 0;
                if (dateA === 0) return direction === 'asc' ? 1 : -1;
                if (dateB === 0) return direction === 'asc' ? -1 : 1;
                
                if (dateA < dateB) return direction === 'asc' ? -1 : 1;
                if (dateA > dateB) return direction === 'asc' ? 1 : -1;
                return 0;
            }
            
            if (typeof valA === 'number') {
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            }

            // ÙØ±Ø² Ù†ØµÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠ
            const strA = String(valA || '').toLowerCase();
            const strB = String(valB || '').toLowerCase();
            if (strA < strB) return direction === 'asc' ? -1 : 1;
            if (strA > strB) return direction === 'asc' ? 1 : -1;
            return 0;
        });

        renderTable();
    }

    /**
     * Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ.
     */
    function renderTable() {
        const tableBody = document.getElementById('student-table-body');
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        
        tableBody.innerHTML = '';

        const filteredStudents = students.filter(student => {
            // Ø¨Ø­Ø« ÙÙˆØ±ÙŠ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø£Ùˆ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
            return (student.name && student.name.toLowerCase().includes(searchTerm)) || 
                   (student.level && student.level.toLowerCase().includes(searchTerm)) ||
                   (student.paymentMethod && student.paymentMethod.toLowerCase().includes(searchTerm)) ||
                   (student.phone && student.phone.toLowerCase().includes(searchTerm)); // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù‡Ø§ØªÙ Ø£ÙŠØ¶Ø§Ù‹
        });
        
        document.getElementById('no-data-message').style.display = filteredStudents.length === 0 ? 'block' : 'none';
        if (filteredStudents.length === 0) return;

        filteredStudents.forEach(student => {
            
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${student.name}</td>
                <td>${student.level}</td>
                <!-- Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠÙ† Ù…Ø¹Ø§Ù‹ -->
                <td class="date-cell">${formatDateTimeDisplay(student.birthDate)}</td>
                <td class="amount-cell">${student.paidAmount.toLocaleString('ar-EG', { style: 'currency', currency: CURRENCY_CODE, minimumFractionDigits: 0 })}</td>
                <td><span style="font-weight: 700; color: var(--accent-color);">${student.paymentMethod || '---'}</span></td>
                <!-- Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠÙ† Ù…Ø¹Ø§Ù‹ -->
                <td class="date-cell">${formatDateTimeDisplay(student.lastPaymentDate)}</td>
                <td class="action-buttons-cell">
                    <button onclick="editStudent('${student.id}')" style="background-color: var(--accent-color);">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                    <button onclick="deleteStudent('${student.id}')" style="background-color: var(--error-color);">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </td>
            `;
        });
    }

    // ======================================================================
    // Ø§Ù„Ù‚Ø³Ù… 9: ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Export / Import Logic)
    // ======================================================================
    
    /**
     * ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…Ù„Ù JSON Ø£Ùˆ CSV
     */
    function exportData(format) {
        if (students.length === 0) {
            showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.', 'info');
            return;
        }

        const formattedStudents = students.map(student => {
            const dateStr = (d) => dateToInputString(d); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
            
            // Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ± Ù„Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©
            const hijriDateStr = (d) => {
                if (!d || isNaN(d.getTime())) return '';
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… 'ar-SA' Ùˆ 'islamic-umalqura' Ù„Ø¶Ù…Ø§Ù† ØªÙ†Ø³ÙŠÙ‚ Ù‡Ø¬Ø±ÙŠ
                return d.toLocaleDateString('ar-SA', { calendar: 'islamic-umalqura', year: 'numeric', month: '2-digit', day: '2-digit' }).replace('Ù‡Ù€', '').trim();
            };

            return {
                ID: student.id,
                Ø§Ù„Ø§Ø³Ù…: student.name,
                Ø§Ù„Ù…Ø³ØªÙˆÙ‰: student.level,
                Ø§Ù„Ù‡Ø§ØªÙ: student.phone || '',
                Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹_Ø¬Ù†ÙŠÙ‡: student.paidAmount, // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„
                Ø·Ø±ÙŠÙ‚Ø©_Ø§Ù„Ø¯ÙØ¹: student.paymentMethod,
                ØªØ§Ø±ÙŠØ®_Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯_Ù…ÙŠÙ„Ø§Ø¯ÙŠ: dateStr(student.birthDate),
                ØªØ§Ø±ÙŠØ®_Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯_Ù‡Ø¬Ø±ÙŠ: hijriDateStr(student.birthDate),
                ØªØ§Ø±ÙŠØ®_Ø¢Ø®Ø±_Ø¯ÙØ¹_Ù…ÙŠÙ„Ø§Ø¯ÙŠ: dateStr(student.lastPaymentDate),
                ØªØ§Ø±ÙŠØ®_Ø¢Ø®Ø±_Ø¯ÙØ¹_Ù‡Ø¬Ø±ÙŠ: hijriDateStr(student.lastPaymentDate)
            };
        });

        if (format === 'json') {
            const jsonStr = JSON.stringify(formattedStudents, null, 2);
            downloadFile(jsonStr, 'student_payments_data_marwan.json', 'application/json');
            showAlert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØªÙ†Ø³ÙŠÙ‚ JSON.', 'success');
        } else if (format === 'csv') {
            const csv = convertToCSV(formattedStudents);
            downloadFile(csv, 'student_payments_data_marwan.csv', 'text/csv;charset=utf-8;');
            showAlert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØªÙ†Ø³ÙŠÙ‚ CSV.', 'success');
        }
    }

    /**
     * ØªØ­ÙˆÙŠÙ„ Ù…ØµÙÙˆÙØ© Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ CSV
     */
    function convertToCSV(objArray) {
        const array = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
        let str = '';
        
        // Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Headers)
        let header = Object.keys(array[0]).map(key => `"${key}"`).join(',');
        str += header + '\r\n';

        // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        for (let i = 0; i < array.length; i++) {
            let line = '';
            for (let index in array[i]) {
                if (line !== '') line += ',';
                // ØªØºÙ„ÙŠÙ Ø§Ù„Ù†ØµÙˆØµ Ø¨Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù‚ØªØ¨Ø§Ø³ Ù…Ø²Ø¯ÙˆØ¬Ø©
                const value = array[i][index] !== null ? String(array[i][index]).replace(/"/g, '""') : '';
                line += `"${value}"`;
            }
            str += line + '\r\n';
        }
        return str;
    }
    
    /**
     * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ù…Ù„Ù JSON
     */
    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                
                if (!Array.isArray(importedData)) {
                    showAlert('âŒ Ø®Ø·Ø£: Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯ Ù„ÙŠØ³ ØªÙ†Ø³ÙŠÙ‚ JSON ØµØ­ÙŠØ­Ù‹Ø§ (Ù…ØµÙÙˆÙØ© Ø¨ÙŠØ§Ù†Ø§Øª).', 'error');
                    return;
                }

                const newStudents = importedData.map(item => {
                    // ØªØ­ÙˆÙŠÙ„ ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
                    const id = item.ID || Date.now().toString() + Math.random().toString(36).substring(2, 9);
                    return {
                        id: id,
                        name: item.Ø§Ù„Ø§Ø³Ù… || 'Ø·Ø§Ù„Ø¨ Ù…Ø¬Ù‡ÙˆÙ„',
                        level: item.Ø§Ù„Ù…Ø³ØªÙˆÙ‰ || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        phone: item.Ø§Ù„Ù‡Ø§ØªÙ || '',
                        // ÙŠØ¬Ø¨ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­ÙˆÙŠÙ„ Ø§Ø³Ù… Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£Ùˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                        paidAmount: Number(item.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹_Ø¬Ù†ÙŠÙ‡ || item.Ø§Ù„Ù…Ø¨Ù„Øº_Ø§Ù„Ù…Ø¯ÙÙˆØ¹_Ø±ÙŠØ§Ù„ || 0),
                        paymentMethod: item.Ø·Ø±ÙŠÙ‚Ø©_Ø§Ù„Ø¯ÙØ¹ || 'Cash',
                        // Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± Ø¯ÙØ¹ Ù…ÙŠÙ„Ø§Ø¯ÙŠ Ù„Ù„ØªØ­ÙˆÙŠÙ„ Ù„ÙƒØ§Ø¦Ù† Date
                        birthDate: item.ØªØ§Ø±ÙŠØ®_Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯_Ù…ÙŠÙ„Ø§Ø¯ÙŠ ? new Date(item.ØªØ§Ø±ÙŠØ®_Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯_Ù…ÙŠÙ„Ø§Ø¯ÙŠ) : null,
                        lastPaymentDate: item.ØªØ§Ø±ÙŠØ®_Ø¢Ø®Ø±_Ø¯ÙØ¹_Ù…ÙŠÙ„Ø§Ø¯ÙŠ ? new Date(item.ØªØ§Ø±ÙŠØ®_Ø¢Ø®Ø±_Ø¯ÙØ¹_Ù…ÙŠÙ„Ø§Ø¯ÙŠ) : new Date(),
                    };
                }).filter(s => s.name.trim() !== 'Ø·Ø§Ù„Ø¨ Ù…Ø¬Ù‡ÙˆÙ„'); // ØªØµÙÙŠØ© Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ© Ø¬Ø¯Ø§Ù‹

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                students.push(...newStudents);
                saveData();
                renderTable();
                calculateAndRenderDashboard();
                showAlert(`âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${newStudents.length} Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­.`, 'success');

            } catch (error) {
                console.error("Error importing data:", error);
                showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù JSON: ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ ØµØ­ÙŠØ­.', 'error');
            }
        };
        reader.readAsText(file);
    }
    
    function downloadFile(content, fileName, mimeType) {
        const blob = new Blob([`\ufeff${content}`], { type: mimeType }); // \ufeff Ù„Ø¥Ø¶Ø§ÙØ© BOM Ù„Ø¯Ø¹Ù… UTF-8 ÙÙŠ CSV
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // ======================================================================
    // Ø§Ù„Ù‚Ø³Ù… 10: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Tabs)
    // ======================================================================
    function openTab(tabId) {
        const tabContents = document.querySelectorAll('.tab-content');
        const tabButtons = document.querySelectorAll('.tab-button');
        
        tabContents.forEach(content => content.classList.remove('active'));
        tabButtons.forEach(button => button.classList.remove('active'));

        document.getElementById(tabId).classList.add('active');
        document.querySelector(`.tab-button[onclick="openTab('${tabId}')"]`).classList.add('active');
        
        // ** Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ØªØ¹Ø¨Ø¦Ø© ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ **
        if (tabId === 'dataEntryTab' && document.getElementById('student-id').value === '') {
            // ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„Ù€ ID ÙØ§Ø±Øº)
            document.getElementById('last-payment-date').value = dateToInputString(new Date());
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù†Ø¯ ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ø±Ø¶
        if (tabId === 'dataViewTab') {
            renderTable();
        }
        // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ù†Ø¯ ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
        if (tabId === 'dashboardTab') {
            calculateAndRenderDashboard();
        }
    }

    // ======================================================================
    // Ø§Ù„Ù‚Ø³Ù… 11: Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ (Initialization)
    // ======================================================================
    window.onload = function() {
        // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ù…Ø­ÙÙˆØ¸ ÙˆØªØ·Ø¨ÙŠÙ‚Ù‡
        loadTheme();
        
        // 2. Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ ÙˆØ§Ù„Ù‡Ø¬Ø±ÙŠ) - ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        updateHeaderDateTime();

        // 3. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
        loadData();
        
        // 4. Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        calculateAndRenderDashboard();
        
        // 5. ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        openTab('dashboardTab'); 
        
        // 6. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø²Ø± Ø§Ù„Ù…Ø³Ø­ ÙŠØ³ØªØ®Ø¯Ù… resetForm(true) Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (ÙÙŠ Ø­Ø§Ù„ Ø¹Ù…Ù„Ù‡Ø§)
        document.getElementById('clear-button').onclick = function() { resetForm(true); };
    };
    
    // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…
    window.openTab = openTab;
    window.editStudent = editStudent;
    window.deleteStudent = deleteStudent;
    window.sortTable = sortTable;
    window.exportData = exportData;
    window.changeTheme = changeTheme;
    window.promptInstall = promptInstall;
    window.importData = importData;

</script>

</body>
</html>